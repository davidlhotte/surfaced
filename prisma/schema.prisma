generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// CORE MODELS - Store Management
// ============================================

model Shop {
  id              String    @id @default(cuid())
  shopDomain      String    @unique
  accessToken     String    // Encrypted AES-256-GCM
  name            String?   // Shop name from Shopify
  email           String?   // Shop owner email
  plan            Plan      @default(FREE)
  planStartedAt   DateTime?
  trialEndsAt     DateTime?

  // AI Readiness Metrics
  productsCount   Int       @default(0)
  aiScore         Int?      // 0-100 overall score
  lastAuditAt     DateTime?

  // Multi-store organization
  organizationId  String?
  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  installedAt     DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  settings              Settings?
  auditLogs             AuditLog[]
  productsAudit         ProductAudit[]
  visibilityChecks      VisibilityCheck[]
  competitors           Competitor[]
  competitorAnalysisResults CompetitorAnalysisResult[]
  llmsTxtConfig         LlmsTxtConfig?
  jsonLdConfig          JsonLdConfig?
  optimizationHistory   ProductOptimizationHistory[]
  abTests               ABTest[]
  apiKeys               ApiKey[]

  @@index([plan])
  @@index([organizationId])
}

model Settings {
  id                String   @id @default(cuid())
  shopId            String   @unique
  shop              Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  // Notification preferences
  emailAlerts       Boolean  @default(true)
  weeklyReport      Boolean  @default(true)

  // Audit preferences
  autoAuditEnabled  Boolean  @default(true)
  auditFrequency    String   @default("weekly") // daily, weekly, monthly

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// ============================================
// MULTI-STORE MODELS - Organization Management
// ============================================

model Organization {
  id              String    @id @default(cuid())
  name            String
  slug            String    @unique
  ownerEmail      String    // Primary admin email
  plan            Plan      @default(FREE)

  // Settings
  maxStores       Int       @default(5)
  features        Json      @default("[]") // Enabled features for org

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  shops           Shop[]
  members         OrganizationMember[]
  invites         OrganizationInvite[]

  @@index([ownerEmail])
}

model OrganizationMember {
  id              String    @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  email           String
  role            OrgRole   @default(viewer)
  name            String?

  joinedAt        DateTime  @default(now())
  lastActiveAt    DateTime?

  @@unique([organizationId, email])
  @@index([email])
}

model OrganizationInvite {
  id              String    @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  email           String
  role            OrgRole   @default(viewer)
  invitedBy       String    // Email of inviter

  token           String    @unique @default(cuid())
  expiresAt       DateTime

  createdAt       DateTime  @default(now())

  @@index([token])
  @@index([email])
}

enum OrgRole {
  owner       // Full access, can manage org
  admin       // Can manage stores and members
  editor      // Can make changes
  viewer      // Read-only access
}

// ============================================
// PUBLIC API MODELS
// ============================================

model ApiKey {
  id              String    @id @default(cuid())
  shopId          String
  shop            Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  name            String    // Friendly name for the key
  keyHash         String    @unique // SHA-256 hash of the actual key
  keyPrefix       String    // First 8 chars for identification (e.g., "sk_live_abc...")

  // Permissions
  scopes          Json      @default("[\"read\"]") // ["read", "write", "audit", "optimize"]

  // Rate limiting
  rateLimit       Int       @default(100) // Requests per minute
  requestCount    Int       @default(0)   // Total requests made
  lastUsedAt      DateTime?

  // Status
  isActive        Boolean   @default(true)
  expiresAt       DateTime?

  createdAt       DateTime  @default(now())
  revokedAt       DateTime?

  // Usage logs
  usageLogs       ApiUsageLog[]

  @@index([shopId])
  @@index([keyHash])
}

model ApiUsageLog {
  id              String    @id @default(cuid())
  apiKeyId        String
  apiKey          ApiKey    @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)

  endpoint        String    // e.g., "/v1/audit"
  method          String    // GET, POST, etc.
  statusCode      Int
  responseTimeMs  Int
  ipAddress       String?

  createdAt       DateTime  @default(now())

  @@index([apiKeyId, createdAt(sort: Desc)])
}

// ============================================
// AUDIT MODELS - Product AI-Readiness
// ============================================

model ProductAudit {
  id                  String    @id @default(cuid())
  shopId              String
  shop                Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  shopifyProductId    BigInt
  title               String
  handle              String

  // AI Readiness Score
  aiScore             Int       // 0-100 for this product
  issues              Json      @default("[]") // Array of AuditIssue objects

  // Quick flags for filtering
  hasImages           Boolean   @default(false)
  hasDescription      Boolean   @default(false)
  hasMetafields       Boolean   @default(false)
  descriptionLength   Int       @default(0)

  lastAuditAt         DateTime  @default(now())
  createdAt           DateTime  @default(now())

  @@unique([shopId, shopifyProductId])
  @@index([shopId])
  @@index([aiScore])
}

// ============================================
// VISIBILITY MODELS - AI Search Tracking
// ============================================

model VisibilityCheck {
  id                String    @id @default(cuid())
  shopId            String
  shop              Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  platform          Platform  // chatgpt, perplexity, gemini, copilot
  query             String    // The search query tested

  // Results
  isMentioned       Boolean?
  mentionContext    String?   // Extract where brand is mentioned
  position          Int?      // Position in recommendations if applicable
  competitorsFound  Json      @default("[]") // Array of {name, url}

  // Raw data for debugging
  rawResponse       String?   @db.Text
  responseQuality   ResponseQuality? // good, partial, none

  checkedAt         DateTime  @default(now())
  createdAt         DateTime  @default(now())

  @@index([shopId])
  @@index([platform])
  @@index([checkedAt(sort: Desc)])
}

model Competitor {
  id          String    @id @default(cuid())
  shopId      String
  shop        Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  domain      String
  name        String?
  isActive    Boolean   @default(true)

  createdAt   DateTime  @default(now())

  // Historical tracking
  analysisResults CompetitorAnalysisResult[]

  @@unique([shopId, domain])
  @@index([shopId])
}

model CompetitorAnalysisResult {
  id              String    @id @default(cuid())
  shopId          String
  shop            Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)
  competitorId    String?
  competitor      Competitor? @relation(fields: [competitorId], references: [id], onDelete: SetNull)

  // Results
  brandMentionRate    Int       // Your mention rate (0-100)
  competitorMentionRate Int?    // Competitor's mention rate if this is for a competitor
  competitorDomain    String?   // Denormalized for history when competitor is deleted
  competitorName      String?   // Denormalized name

  // Query details
  queriesRun          Int       @default(0)
  queriesMentioned    Int       @default(0)

  // Position data
  avgPosition         Float?
  bestPosition        Int?
  worstPosition       Int?

  analyzedAt          DateTime  @default(now())

  @@index([shopId, analyzedAt(sort: Desc)])
  @@index([competitorId])
}

// ============================================
// LLMS.TXT MODELS - AI Crawler Configuration
// ============================================

model LlmsTxtConfig {
  id                  String    @id @default(cuid())
  shopId              String    @unique
  shop                Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  isEnabled           Boolean   @default(true)
  allowedBots         Json      @default("[\"ChatGPT-User\", \"GPTBot\", \"ClaudeBot\", \"PerplexityBot\", \"Google-Extended\"]")

  // Content inclusion settings
  includeProducts     Boolean   @default(true)
  includeCollections  Boolean   @default(true)
  includeBlog         Boolean   @default(false)

  excludedProductIds  Json      @default("[]")
  customInstructions  String?   @db.Text

  lastGeneratedAt     DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
}

// ============================================
// JSON-LD MODELS - Structured Data Configuration
// ============================================

model JsonLdConfig {
  id                      String    @id @default(cuid())
  shopId                  String    @unique
  shop                    Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  isEnabled               Boolean   @default(true)

  // Schema inclusion settings
  includeOrganization     Boolean   @default(true)
  includeProducts         Boolean   @default(true)
  includeBreadcrumbs      Boolean   @default(true)

  excludedProductIds      Json      @default("[]")
  customOrganizationData  Json?     // Custom organization schema overrides

  lastGeneratedAt         DateTime?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
}

// ============================================
// OPTIMIZATION HISTORY - Track Applied Changes
// ============================================

model ProductOptimizationHistory {
  id                  String    @id @default(cuid())
  shopId              String
  shop                Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  shopifyProductId    BigInt
  productTitle        String    // Snapshot of product title at time of change

  field               String    // description, seo_title, seo_description, tags, etc.
  originalValue       String    @db.Text
  appliedValue        String    @db.Text
  reasoning           String?   // AI reasoning for the suggestion

  // Score tracking
  scoreBefore         Int?
  scoreAfter          Int?

  // Status
  status              OptimizationStatus @default(applied)
  undoneAt            DateTime?

  appliedAt           DateTime  @default(now())
  createdAt           DateTime  @default(now())

  @@index([shopId])
  @@index([shopifyProductId])
  @@index([appliedAt(sort: Desc)])
}

// ============================================
// LOGGING
// ============================================

model AuditLog {
  id          String    @id @default(cuid())
  shopId      String
  shop        Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  action      String    // install, uninstall, audit_started, visibility_check, etc.
  details     Json?
  ipAddress   String?

  createdAt   DateTime  @default(now())

  @@index([shopId, createdAt])
  @@index([action])
}

// ============================================
// ENUMS
// ============================================

enum Plan {
  FREE      // Free tier / Trial
  BASIC     // $49/month (Starter)
  PLUS      // $99/month (Growth)
  PREMIUM   // $199/month (Scale)
}

enum Platform {
  // Major AI Assistants (Paid via OpenRouter)
  chatgpt       // OpenAI GPT-4o-mini
  perplexity    // Perplexity Sonar (with web search)
  gemini        // Google Gemini 2.0 Flash
  copilot       // Microsoft Copilot alternative
  claude        // Anthropic Claude

  // Free Models (via OpenRouter)
  llama         // Meta Llama 3.3 70B
  deepseek      // DeepSeek R1
  mistral       // Mistral AI
  qwen          // Alibaba Qwen
}

enum ResponseQuality {
  good      // Brand clearly mentioned with context
  partial   // Brand mentioned but vaguely
  none      // Not mentioned
}

enum OptimizationStatus {
  applied   // Change was applied to product
  undone    // Change was reverted
}

// ============================================
// A/B TESTING MODELS
// ============================================

model ABTest {
  id                  String    @id @default(cuid())
  shopId              String
  shop                Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  name                String    // Test name for identification
  shopifyProductId    BigInt
  productTitle        String    // Snapshot of product title
  field               ABTestField

  // Variants
  variantA            String    @db.Text // Current/control content
  variantB            String    @db.Text // Test content

  // Test configuration
  testQueries         Json      @default("[]") // Array of queries to test with
  queriesPerVariant   Int       @default(5)

  // Results
  variantAMentions    Int       @default(0)
  variantBMentions    Int       @default(0)
  variantAAvgPosition Float?
  variantBAvgPosition Float?
  totalChecks         Int       @default(0)

  // Status
  status              ABTestStatus @default(draft)
  winner              ABTestWinner?
  winnerApplied       Boolean   @default(false)

  startedAt           DateTime?
  completedAt         DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Results history
  testResults         ABTestResult[]

  @@index([shopId])
  @@index([status])
}

model ABTestResult {
  id              String    @id @default(cuid())
  testId          String
  test            ABTest    @relation(fields: [testId], references: [id], onDelete: Cascade)

  variant         ABTestWinner  // A or B
  query           String
  platform        Platform

  isMentioned     Boolean
  position        Int?
  context         String?       @db.Text

  testedAt        DateTime  @default(now())

  @@index([testId])
}

enum ABTestField {
  description
  seo_title
  seo_description
  tags
}

enum ABTestStatus {
  draft       // Not started
  running     // Test in progress
  completed   // Test finished
  cancelled   // User cancelled
}

enum ABTestWinner {
  A           // Variant A (control) won
  B           // Variant B (test) won
  tie         // No significant difference
}
