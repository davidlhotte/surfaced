generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// CORE MODELS - Store Management
// ============================================

model Shop {
  id              String    @id @default(cuid())
  shopDomain      String    @unique
  accessToken     String    // Encrypted AES-256-GCM
  name            String?   // Shop name from Shopify
  email           String?   // Shop owner email
  plan            Plan      @default(FREE)
  planOverride    Plan?     // Manual override (takes priority over Shopify subscription)
  planStartedAt   DateTime?
  trialEndsAt     DateTime?

  // AI Readiness Metrics
  productsCount   Int       @default(0)
  aiScore         Int?      // 0-100 overall score
  lastAuditAt     DateTime?

  // Multi-store organization
  organizationId  String?
  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  installedAt     DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  settings              Settings?
  auditLogs             AuditLog[]
  productsAudit         ProductAudit[]
  visibilityChecks      VisibilityCheck[]
  competitors           Competitor[]
  competitorAnalysisResults CompetitorAnalysisResult[]
  llmsTxtConfig         LlmsTxtConfig?
  jsonLdConfig          JsonLdConfig?
  optimizationHistory   ProductOptimizationHistory[]
  abTests               ABTest[]
  apiKeys               ApiKey[]

  @@index([plan])
  @@index([organizationId])
}

model Settings {
  id                String   @id @default(cuid())
  shopId            String   @unique
  shop              Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  // Notification preferences
  emailAlerts       Boolean  @default(true)
  weeklyReport      Boolean  @default(true)

  // Audit preferences
  autoAuditEnabled  Boolean  @default(true)
  auditFrequency    String   @default("weekly") // daily, weekly, monthly

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// ============================================
// MULTI-STORE MODELS - Organization Management
// ============================================

model Organization {
  id              String    @id @default(cuid())
  name            String
  slug            String    @unique
  ownerEmail      String    // Primary admin email
  plan            Plan      @default(FREE)

  // Settings
  maxStores       Int       @default(5)
  features        Json      @default("[]") // Enabled features for org

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  shops           Shop[]
  members         OrganizationMember[]
  invites         OrganizationInvite[]

  @@index([ownerEmail])
}

model OrganizationMember {
  id              String    @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  email           String
  role            OrgRole   @default(viewer)
  name            String?

  joinedAt        DateTime  @default(now())
  lastActiveAt    DateTime?

  @@unique([organizationId, email])
  @@index([email])
}

model OrganizationInvite {
  id              String    @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  email           String
  role            OrgRole   @default(viewer)
  invitedBy       String    // Email of inviter

  token           String    @unique @default(cuid())
  expiresAt       DateTime

  createdAt       DateTime  @default(now())

  @@index([token])
  @@index([email])
}

enum OrgRole {
  owner       // Full access, can manage org
  admin       // Can manage stores and members
  editor      // Can make changes
  viewer      // Read-only access
}

// ============================================
// PUBLIC API MODELS
// ============================================

model ApiKey {
  id              String    @id @default(cuid())
  shopId          String
  shop            Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  name            String    // Friendly name for the key
  keyHash         String    @unique // SHA-256 hash of the actual key
  keyPrefix       String    // First 8 chars for identification (e.g., "sk_live_abc...")

  // Permissions
  scopes          Json      @default("[\"read\"]") // ["read", "write", "audit", "optimize"]

  // Rate limiting
  rateLimit       Int       @default(100) // Requests per minute
  requestCount    Int       @default(0)   // Total requests made
  lastUsedAt      DateTime?

  // Status
  isActive        Boolean   @default(true)
  expiresAt       DateTime?

  createdAt       DateTime  @default(now())
  revokedAt       DateTime?

  // Usage logs
  usageLogs       ApiUsageLog[]

  @@index([shopId])
  @@index([keyHash])
}

model ApiUsageLog {
  id              String    @id @default(cuid())
  apiKeyId        String
  apiKey          ApiKey    @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)

  endpoint        String    // e.g., "/v1/audit"
  method          String    // GET, POST, etc.
  statusCode      Int
  responseTimeMs  Int
  ipAddress       String?

  createdAt       DateTime  @default(now())

  @@index([apiKeyId, createdAt(sort: Desc)])
}

// ============================================
// AUDIT MODELS - Product AI-Readiness
// ============================================

model ProductAudit {
  id                  String    @id @default(cuid())
  shopId              String
  shop                Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  shopifyProductId    BigInt
  title               String
  handle              String

  // AI Readiness Score
  aiScore             Int       // 0-100 for this product
  issues              Json      @default("[]") // Array of AuditIssue objects

  // Quick flags for filtering
  hasImages           Boolean   @default(false)
  hasDescription      Boolean   @default(false)
  hasMetafields       Boolean   @default(false)
  descriptionLength   Int       @default(0)

  lastAuditAt         DateTime  @default(now())
  createdAt           DateTime  @default(now())

  @@unique([shopId, shopifyProductId])
  @@index([shopId])
  @@index([aiScore])
  @@index([shopId, aiScore])  // Composite for filtered score queries
}

// ============================================
// VISIBILITY MODELS - AI Search Tracking
// ============================================

model VisibilityCheck {
  id                String    @id @default(cuid())
  shopId            String
  shop              Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  platform          Platform  // chatgpt, perplexity, gemini, copilot
  query             String    // The search query tested
  sessionId         String?   // Groups checks from the same run together

  // Results
  isMentioned       Boolean?
  mentionContext    String?   // Extract where brand is mentioned
  position          Int?      // Position in recommendations if applicable
  competitorsFound  Json      @default("[]") // Array of {name, url}

  // Raw data for debugging
  rawResponse       String?   @db.Text
  responseQuality   ResponseQuality? // good, partial, none

  checkedAt         DateTime  @default(now())
  createdAt         DateTime  @default(now())

  @@index([shopId])
  @@index([platform])
  @@index([checkedAt(sort: Desc)])
  @@index([sessionId])
  @@index([shopId, isMentioned, checkedAt(sort: Desc)])  // Composite for visibility analysis
}

model Competitor {
  id          String    @id @default(cuid())
  shopId      String
  shop        Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  domain      String
  name        String?
  isActive    Boolean   @default(true)

  createdAt   DateTime  @default(now())

  // Historical tracking
  analysisResults CompetitorAnalysisResult[]

  @@unique([shopId, domain])
  @@index([shopId])
}

model CompetitorAnalysisResult {
  id              String    @id @default(cuid())
  shopId          String
  shop            Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)
  competitorId    String?
  competitor      Competitor? @relation(fields: [competitorId], references: [id], onDelete: SetNull)

  // Results
  brandMentionRate    Int       // Your mention rate (0-100)
  competitorMentionRate Int?    // Competitor's mention rate if this is for a competitor
  competitorDomain    String?   // Denormalized for history when competitor is deleted
  competitorName      String?   // Denormalized name

  // Query details
  queriesRun          Int       @default(0)
  queriesMentioned    Int       @default(0)

  // Position data
  avgPosition         Float?
  bestPosition        Int?
  worstPosition       Int?

  analyzedAt          DateTime  @default(now())

  @@index([shopId, analyzedAt(sort: Desc)])
  @@index([competitorId])
}

// ============================================
// LLMS.TXT MODELS - AI Crawler Configuration
// ============================================

model LlmsTxtConfig {
  id                  String    @id @default(cuid())
  shopId              String    @unique
  shop                Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  isEnabled           Boolean   @default(true)
  allowedBots         Json      @default("[\"ChatGPT-User\", \"GPTBot\", \"ClaudeBot\", \"PerplexityBot\", \"Google-Extended\"]")

  // Content inclusion settings
  includeProducts     Boolean   @default(true)
  includeCollections  Boolean   @default(true)
  includeBlog         Boolean   @default(false)

  excludedProductIds  Json      @default("[]")
  customInstructions  String?   @db.Text

  lastGeneratedAt     DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
}

// ============================================
// JSON-LD MODELS - Structured Data Configuration
// ============================================

model JsonLdConfig {
  id                      String    @id @default(cuid())
  shopId                  String    @unique
  shop                    Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  isEnabled               Boolean   @default(true)

  // Schema inclusion settings
  includeOrganization     Boolean   @default(true)
  includeProducts         Boolean   @default(true)
  includeBreadcrumbs      Boolean   @default(true)

  excludedProductIds      Json      @default("[]")
  customOrganizationData  Json?     // Custom organization schema overrides

  lastGeneratedAt         DateTime?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
}

// ============================================
// OPTIMIZATION HISTORY - Track Applied Changes
// ============================================

model ProductOptimizationHistory {
  id                  String    @id @default(cuid())
  shopId              String
  shop                Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  shopifyProductId    BigInt
  productTitle        String    // Snapshot of product title at time of change

  field               String    // description, seo_title, seo_description, tags, etc.
  originalValue       String    @db.Text
  appliedValue        String    @db.Text
  reasoning           String?   // AI reasoning for the suggestion

  // Score tracking
  scoreBefore         Int?
  scoreAfter          Int?

  // Status
  status              OptimizationStatus @default(applied)
  undoneAt            DateTime?

  appliedAt           DateTime  @default(now())
  createdAt           DateTime  @default(now())

  @@index([shopId])
  @@index([shopifyProductId])
  @@index([appliedAt(sort: Desc)])
}

// ============================================
// LOGGING
// ============================================

model AuditLog {
  id          String    @id @default(cuid())
  shopId      String
  shop        Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  action      String    // install, uninstall, audit_started, visibility_check, etc.
  details     Json?
  ipAddress   String?

  createdAt   DateTime  @default(now())

  @@index([shopId, createdAt])
  @@index([action])
}

// ============================================
// ENUMS
// ============================================

enum Plan {
  FREE      // Free tier / Trial
  BASIC     // $49/month (Starter)
  PLUS      // $99/month (Growth)
  PREMIUM   // $199/month (Scale)
}

enum Platform {
  // Core Platforms (All Plans)
  chatgpt       // OpenAI GPT-4o-mini
  claude        // Anthropic Claude
  perplexity    // Perplexity Sonar (with web search)
  gemini        // Google Gemini 2.0 Flash

  // Extended Platforms (PRO+)
  google_ai     // Google AI Overviews
  copilot       // Microsoft Copilot

  // Premium Platforms (BUSINESS+)
  deepseek      // DeepSeek
  grok          // xAI Grok
  meta_ai       // Meta AI (Llama)

  // Legacy (kept for compatibility)
  llama         // Meta Llama 3.3 70B (deprecated, use meta_ai)
  mistral       // Mistral AI
  qwen          // Alibaba Qwen
}

enum JourneyStage {
  awareness     // Top of funnel - discovering options
  consideration // Middle - comparing solutions
  decision      // Bottom - ready to buy
  branded       // Searching specifically for your brand
}

enum Region {
  us            // United States
  eu            // European Union
  uk            // United Kingdom
  ca            // Canada
  au            // Australia
  fr            // France
  de            // Germany
  jp            // Japan
  global        // Global/Unspecified
}

enum PlatformTier {
  core          // All plans
  extended      // PRO+
  premium       // BUSINESS+
}

enum ResponseQuality {
  good      // Brand clearly mentioned with context
  partial   // Brand mentioned but vaguely
  none      // Not mentioned
}

enum OptimizationStatus {
  applied   // Change was applied to product
  undone    // Change was reverted
}

// ============================================
// A/B TESTING MODELS
// ============================================

model ABTest {
  id                  String    @id @default(cuid())
  shopId              String
  shop                Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  name                String    // Test name for identification
  shopifyProductId    BigInt
  productTitle        String    // Snapshot of product title
  field               ABTestField

  // Variants
  variantA            String    @db.Text // Current/control content
  variantB            String    @db.Text // Test content

  // Test configuration
  testQueries         Json      @default("[]") // Array of queries to test with
  queriesPerVariant   Int       @default(5)

  // Results
  variantAMentions    Int       @default(0)
  variantBMentions    Int       @default(0)
  variantAAvgPosition Float?
  variantBAvgPosition Float?
  totalChecks         Int       @default(0)

  // Status
  status              ABTestStatus @default(draft)
  winner              ABTestWinner?
  winnerApplied       Boolean   @default(false)

  startedAt           DateTime?
  completedAt         DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Results history
  testResults         ABTestResult[]

  @@index([shopId])
  @@index([status])
}

model ABTestResult {
  id              String    @id @default(cuid())
  testId          String
  test            ABTest    @relation(fields: [testId], references: [id], onDelete: Cascade)

  variant         ABTestWinner  // A or B
  query           String
  platform        Platform

  isMentioned     Boolean
  position        Int?
  context         String?       @db.Text

  testedAt        DateTime  @default(now())

  @@index([testId])
}

enum ABTestField {
  description
  seo_title
  seo_description
  tags
}

enum ABTestStatus {
  draft       // Not started
  running     // Test in progress
  completed   // Test finished
  cancelled   // User cancelled
}

enum ABTestWinner {
  A           // Variant A (control) won
  B           // Variant B (test) won
  tie         // No significant difference
}

// ============================================
// UNIVERSAL USER MODELS (Non-Shopify)
// ============================================

model UniversalUser {
  id                String    @id @default(cuid())
  email             String    @unique
  passwordHash      String?   // For email/password auth (null if using OAuth only)
  googleId          String?   @unique // For Google OAuth

  name              String?
  avatarUrl         String?

  // Auth provider
  authProvider      String?   // 'email', 'google', 'supabase'
  providerId        String?   // Provider-specific ID (Supabase user ID, Google ID, etc.)

  // Subscription
  plan              String    @default("FREE") // FREE, PRO, BUSINESS, ENTERPRISE
  planStartedAt     DateTime?
  trialEndsAt       DateTime?
  stripeCustomerId  String?   @unique
  stripeSubscriptionId     String?
  stripeSubscriptionStatus String?
  subscriptionEndsAt       DateTime?

  // Email verification
  emailVerified     Boolean   @default(false)
  emailVerifyToken  String?   @unique

  // Password reset
  passwordResetToken    String?   @unique
  passwordResetExpires  DateTime?

  // Activity
  lastLoginAt       DateTime?
  loginCount        Int       @default(0)

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  brands            Brand[]
  sessions          UniversalSession[]
  teamMemberships   TeamMember[]
  ownedTeams        Team[]           @relation("TeamOwner")

  @@index([email])
  @@index([stripeCustomerId])
}

model UniversalSession {
  id            String    @id @default(cuid())
  userId        String
  user          UniversalUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  token         String    @unique
  expiresAt     DateTime

  // Session info
  ipAddress     String?
  userAgent     String?

  createdAt     DateTime  @default(now())
  lastActiveAt  DateTime  @default(now())

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model Brand {
  id            String    @id @default(cuid())
  userId        String
  user          UniversalUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  name          String
  domain        String?   // Optional website URL
  industry      String?   // For better AI prompts
  description   String?   @db.Text

  // AEO Metrics
  aeoScore      Int?      // 0-100 overall score
  lastCheckAt   DateTime?

  // Report settings
  reportSchedule Json?    // {enabled, email, dayOfWeek, lastSent}

  // Team sharing
  teamId        String?
  team          Team?     @relation(fields: [teamId], references: [id], onDelete: SetNull)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  visibilityChecks    BrandVisibilityCheck[]
  competitors         BrandCompetitor[]
  customPrompts       BrandPrompt[]
  alerts              BrandAlert[]

  // Phase 1-3 Relations
  citations               Citation[]
  gapAnalysisResults      GapAnalysisResult[]
  trafficEstimations      TrafficEstimation[]
  axpConfig               AXPConfig?
  ga4Integration          GA4Integration?
  enhancedVisibilityChecks EnhancedVisibilityCheck[]

  @@unique([userId, name])
  @@index([userId])
  @@index([teamId])
}

// ============================================
// TEAM MODELS - Enterprise Features
// ============================================

model Team {
  id          String    @id @default(cuid())
  name        String
  slug        String    @unique
  ownerId     String
  owner       UniversalUser @relation("TeamOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  members     TeamMember[]
  invites     TeamInvite[]
  brands      Brand[]

  @@index([ownerId])
}

model TeamMember {
  id        String    @id @default(cuid())
  userId    String
  user      UniversalUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  teamId    String
  team      Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)

  role      String    @default("member") // owner, admin, member, viewer

  joinedAt  DateTime  @default(now())

  @@unique([userId, teamId])
  @@index([teamId])
}

model TeamInvite {
  id          String    @id @default(cuid())
  teamId      String
  team        Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)

  email       String
  role        String    @default("member")
  token       String    @unique
  invitedBy   String    // User ID who sent the invite

  expiresAt   DateTime
  createdAt   DateTime  @default(now())

  @@index([teamId])
  @@index([token])
  @@index([email])
}

model BrandVisibilityCheck {
  id                String    @id @default(cuid())
  brandId           String
  brand             Brand     @relation(fields: [brandId], references: [id], onDelete: Cascade)

  // Results
  aeoScore          Int       // Score for this check
  chatgptResult     Json?     // {mentioned, position, snippet, sentiment}
  claudeResult      Json?
  perplexityResult  Json?
  geminiResult      Json?

  // Prompts used
  promptsUsed       Json      @default("[]")

  checkedAt         DateTime  @default(now())

  @@index([brandId])
  @@index([checkedAt(sort: Desc)])
}

model BrandCompetitor {
  id              String    @id @default(cuid())
  brandId         String
  brand           Brand     @relation(fields: [brandId], references: [id], onDelete: Cascade)

  competitorName  String
  competitorDomain String?

  // Last comparison data
  lastComparedAt  DateTime?
  yourScore       Int?
  theirScore      Int?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([brandId, competitorName])
  @@index([brandId])
}

model BrandPrompt {
  id          String    @id @default(cuid())
  brandId     String
  brand       Brand     @relation(fields: [brandId], references: [id], onDelete: Cascade)

  prompt      String    @db.Text
  category    String    // 'general', 'product', 'comparison'

  createdAt   DateTime  @default(now())

  @@index([brandId])
}

model BrandAlert {
  id          String    @id @default(cuid())
  brandId     String
  brand       Brand     @relation(fields: [brandId], references: [id], onDelete: Cascade)

  type        AlertType
  threshold   Int?      // For score alerts

  isActive    Boolean   @default(true)
  lastTriggeredAt DateTime?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([brandId])
}

// Email signups from free tools
model EmailSignup {
  id              String    @id @default(cuid())
  email           String    @unique
  source          String    // 'checker', 'score', 'compare', 'landing'
  brandChecked    String?   // What brand they checked

  convertedToUser Boolean   @default(false)
  convertedAt     DateTime?

  createdAt       DateTime  @default(now())

  @@index([email])
  @@index([source])
}

enum UniversalPlan {
  FREE      // 3 checks/month
  STARTER   // $29/month
  GROWTH    // $79/month
  SCALE     // $149/month
}

enum AlertType {
  SCORE_DROP    // Alert when AEO score drops below threshold
  COMPETITOR    // Alert when competitor gains position
  MENTION_LOST  // Alert when brand stops being mentioned
  WEEKLY_REPORT // Weekly summary
}

// ============================================
// ENHANCED AI VISIBILITY MODELS (Phase 1-3)
// ============================================

// Citation tracking - URLs cited by AI platforms
model Citation {
  id              String    @id @default(cuid())
  brandId         String
  brand           Brand     @relation(fields: [brandId], references: [id], onDelete: Cascade)
  visibilityCheckId String?

  url             String
  domain          String
  isOwnSite       Boolean   @default(false)
  context         String?   @db.Text

  platform        Platform
  journeyStage    JourneyStage
  region          Region    @default(global)

  discoveredAt    DateTime  @default(now())

  @@index([brandId])
  @@index([domain])
  @@index([platform])
}

// Gap Analysis - where competitors appear but you don't
model GapAnalysisResult {
  id              String    @id @default(cuid())
  brandId         String
  brand           Brand     @relation(fields: [brandId], references: [id], onDelete: Cascade)

  platform        Platform
  query           String
  journeyStage    JourneyStage
  region          Region    @default(global)

  // Your brand
  yourMentioned   Boolean   @default(false)
  yourPosition    Int?

  // Competitors found in this gap
  competitorsMentioned Json  @default("[]") // Array of {name, position}
  competitorCount Int       @default(0)

  // Opportunity assessment
  opportunity     String    @default("medium") // high, medium, low
  recommendation  String?   @db.Text

  analyzedAt      DateTime  @default(now())

  @@index([brandId])
  @@index([opportunity])
  @@index([journeyStage])
}

// Traffic Estimation - estimates based on visibility
model TrafficEstimation {
  id                      String    @id @default(cuid())
  brandId                 String
  brand                   Brand     @relation(fields: [brandId], references: [id], onDelete: Cascade)

  // Monthly estimates
  estimatedMonthlyAIVisits      Int
  estimatedMonthlyAIReferrals   Int

  // Breakdown by platform
  platformBreakdown       Json      @default("[]") // Array of {platform, visits, marketShare}

  // Breakdown by journey stage
  journeyBreakdown        Json      @default("{}") // {awareness, consideration, decision, branded}

  // Missed opportunity
  estimatedLostVisits     Int       @default(0)
  topMissedPlatforms      Json      @default("[]")
  recommendations         Json      @default("[]")

  // Calculation metadata
  monthlySearchVolume     Int?      // If known
  industry                String?
  confidence              String    @default("medium") // high, medium, low

  calculatedAt            DateTime  @default(now())

  @@index([brandId])
  @@index([calculatedAt(sort: Desc)])
}

// AXP Configuration - AI Experience Platform settings
model AXPConfig {
  id                  String    @id @default(cuid())
  brandId             String    @unique
  brand               Brand     @relation(fields: [brandId], references: [id], onDelete: Cascade)

  // llms.txt configuration
  llmsTxtEnabled      Boolean   @default(false)
  llmsTxtContent      String?   @db.Text
  llmsFullTxtContent  String?   @db.Text

  // JSON-LD configuration
  jsonLdEnabled       Boolean   @default(false)
  organizationSchema  Json?
  websiteSchema       Json?
  productSchemas      Json?     @default("[]")
  faqSchema           Json?

  // Meta descriptions
  metaDescriptions    Json?     @default("{}")

  // AI snippets
  aiSnippets          Json?     @default("[]")

  // Content recommendations
  contentRecommendations Json?  @default("[]")

  // Validation results
  llmsTxtScore        Int?      // 0-100
  lastValidatedAt     DateTime?
  validationErrors    Json?     @default("[]")
  validationWarnings  Json?     @default("[]")

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([brandId])
}

// GA4 Integration - Google Analytics connection
model GA4Integration {
  id                  String    @id @default(cuid())
  brandId             String    @unique
  brand               Brand     @relation(fields: [brandId], references: [id], onDelete: Cascade)

  // GA4 Property
  propertyId          String
  propertyName        String?

  // OAuth tokens (encrypted)
  accessToken         String?   // Encrypted
  refreshToken        String?   // Encrypted
  tokenExpiresAt      DateTime?

  // Cached analytics data
  lastFetchedAt       DateTime?
  cachedTotalSessions Int?
  cachedAITraffic     Json?     // AI traffic breakdown
  cachedAIPercent     Float?    // % of traffic from AI
  cachedTrend         Json?     // {direction, changePercent}

  // Top landing pages for AI traffic
  cachedTopPages      Json?     @default("[]")

  // Correlation data
  correlationData     Json?     @default("[]")

  // Settings
  autoFetchEnabled    Boolean   @default(true)
  fetchFrequency      String    @default("daily") // daily, weekly

  isConnected         Boolean   @default(false)
  connectionError     String?

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([brandId])
}

// Enhanced Visibility Check with Phase 1-3 data
model EnhancedVisibilityCheck {
  id                String    @id @default(cuid())
  brandId           String
  brand             Brand     @relation(fields: [brandId], references: [id], onDelete: Cascade)

  // Basic results
  aeoScore          Int
  platform          Platform
  journeyStage      JourneyStage
  region            Region    @default(global)

  // Mention details
  mentioned         Boolean   @default(false)
  position          Int?
  sentiment         String?   // positive, neutral, negative
  snippet           String?   @db.Text

  // Query used
  query             String

  // Competitors found
  competitorsFound  Json      @default("[]")

  // Citations extracted
  citationsFound    Json      @default("[]")
  ownSiteCited      Boolean   @default(false)

  // Raw response for analysis
  rawResponse       String?   @db.Text

  checkedAt         DateTime  @default(now())

  @@index([brandId])
  @@index([platform])
  @@index([journeyStage])
  @@index([checkedAt(sort: Desc)])
}
