generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// CORE MODELS - Store Management
// ============================================

model Shop {
  id              String    @id @default(cuid())
  shopDomain      String    @unique
  accessToken     String    // Encrypted AES-256-GCM
  name            String?   // Shop name from Shopify
  email           String?   // Shop owner email
  plan            Plan      @default(FREE)
  planStartedAt   DateTime?
  trialEndsAt     DateTime?

  // AI Readiness Metrics
  productsCount   Int       @default(0)
  aiScore         Int?      // 0-100 overall score
  lastAuditAt     DateTime?

  installedAt     DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  settings              Settings?
  auditLogs             AuditLog[]
  productsAudit         ProductAudit[]
  visibilityChecks      VisibilityCheck[]
  competitors           Competitor[]
  competitorAnalysisResults CompetitorAnalysisResult[]
  llmsTxtConfig         LlmsTxtConfig?
  jsonLdConfig          JsonLdConfig?
  optimizationHistory   ProductOptimizationHistory[]

  @@index([plan])
}

model Settings {
  id                String   @id @default(cuid())
  shopId            String   @unique
  shop              Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  // Notification preferences
  emailAlerts       Boolean  @default(true)
  weeklyReport      Boolean  @default(true)

  // Audit preferences
  autoAuditEnabled  Boolean  @default(true)
  auditFrequency    String   @default("weekly") // daily, weekly, monthly

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// ============================================
// AUDIT MODELS - Product AI-Readiness
// ============================================

model ProductAudit {
  id                  String    @id @default(cuid())
  shopId              String
  shop                Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  shopifyProductId    BigInt
  title               String
  handle              String

  // AI Readiness Score
  aiScore             Int       // 0-100 for this product
  issues              Json      @default("[]") // Array of AuditIssue objects

  // Quick flags for filtering
  hasImages           Boolean   @default(false)
  hasDescription      Boolean   @default(false)
  hasMetafields       Boolean   @default(false)
  descriptionLength   Int       @default(0)

  lastAuditAt         DateTime  @default(now())
  createdAt           DateTime  @default(now())

  @@unique([shopId, shopifyProductId])
  @@index([shopId])
  @@index([aiScore])
}

// ============================================
// VISIBILITY MODELS - AI Search Tracking
// ============================================

model VisibilityCheck {
  id                String    @id @default(cuid())
  shopId            String
  shop              Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  platform          Platform  // chatgpt, perplexity, gemini, copilot
  query             String    // The search query tested

  // Results
  isMentioned       Boolean?
  mentionContext    String?   // Extract where brand is mentioned
  position          Int?      // Position in recommendations if applicable
  competitorsFound  Json      @default("[]") // Array of {name, url}

  // Raw data for debugging
  rawResponse       String?   @db.Text
  responseQuality   ResponseQuality? // good, partial, none

  checkedAt         DateTime  @default(now())
  createdAt         DateTime  @default(now())

  @@index([shopId])
  @@index([platform])
  @@index([checkedAt(sort: Desc)])
}

model Competitor {
  id          String    @id @default(cuid())
  shopId      String
  shop        Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  domain      String
  name        String?
  isActive    Boolean   @default(true)

  createdAt   DateTime  @default(now())

  // Historical tracking
  analysisResults CompetitorAnalysisResult[]

  @@unique([shopId, domain])
  @@index([shopId])
}

model CompetitorAnalysisResult {
  id              String    @id @default(cuid())
  shopId          String
  shop            Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)
  competitorId    String?
  competitor      Competitor? @relation(fields: [competitorId], references: [id], onDelete: SetNull)

  // Results
  brandMentionRate    Int       // Your mention rate (0-100)
  competitorMentionRate Int?    // Competitor's mention rate if this is for a competitor
  competitorDomain    String?   // Denormalized for history when competitor is deleted
  competitorName      String?   // Denormalized name

  // Query details
  queriesRun          Int       @default(0)
  queriesMentioned    Int       @default(0)

  // Position data
  avgPosition         Float?
  bestPosition        Int?
  worstPosition       Int?

  analyzedAt          DateTime  @default(now())

  @@index([shopId, analyzedAt(sort: Desc)])
  @@index([competitorId])
}

// ============================================
// LLMS.TXT MODELS - AI Crawler Configuration
// ============================================

model LlmsTxtConfig {
  id                  String    @id @default(cuid())
  shopId              String    @unique
  shop                Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  isEnabled           Boolean   @default(true)
  allowedBots         Json      @default("[\"ChatGPT-User\", \"GPTBot\", \"ClaudeBot\", \"PerplexityBot\", \"Google-Extended\"]")

  // Content inclusion settings
  includeProducts     Boolean   @default(true)
  includeCollections  Boolean   @default(true)
  includeBlog         Boolean   @default(false)

  excludedProductIds  Json      @default("[]")
  customInstructions  String?   @db.Text

  lastGeneratedAt     DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
}

// ============================================
// JSON-LD MODELS - Structured Data Configuration
// ============================================

model JsonLdConfig {
  id                      String    @id @default(cuid())
  shopId                  String    @unique
  shop                    Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  isEnabled               Boolean   @default(true)

  // Schema inclusion settings
  includeOrganization     Boolean   @default(true)
  includeProducts         Boolean   @default(true)
  includeBreadcrumbs      Boolean   @default(true)

  excludedProductIds      Json      @default("[]")
  customOrganizationData  Json?     // Custom organization schema overrides

  lastGeneratedAt         DateTime?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
}

// ============================================
// OPTIMIZATION HISTORY - Track Applied Changes
// ============================================

model ProductOptimizationHistory {
  id                  String    @id @default(cuid())
  shopId              String
  shop                Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  shopifyProductId    BigInt
  productTitle        String    // Snapshot of product title at time of change

  field               String    // description, seo_title, seo_description, tags, etc.
  originalValue       String    @db.Text
  appliedValue        String    @db.Text
  reasoning           String?   // AI reasoning for the suggestion

  // Score tracking
  scoreBefore         Int?
  scoreAfter          Int?

  // Status
  status              OptimizationStatus @default(applied)
  undoneAt            DateTime?

  appliedAt           DateTime  @default(now())
  createdAt           DateTime  @default(now())

  @@index([shopId])
  @@index([shopifyProductId])
  @@index([appliedAt(sort: Desc)])
}

// ============================================
// LOGGING
// ============================================

model AuditLog {
  id          String    @id @default(cuid())
  shopId      String
  shop        Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  action      String    // install, uninstall, audit_started, visibility_check, etc.
  details     Json?
  ipAddress   String?

  createdAt   DateTime  @default(now())

  @@index([shopId, createdAt])
  @@index([action])
}

// ============================================
// ENUMS
// ============================================

enum Plan {
  FREE      // Free tier / Trial
  BASIC     // $49/month (Starter)
  PLUS      // $99/month (Growth)
  PREMIUM   // $199/month (Scale)
}

enum Platform {
  chatgpt
  perplexity
  gemini
  copilot
}

enum ResponseQuality {
  good      // Brand clearly mentioned with context
  partial   // Brand mentioned but vaguely
  none      // Not mentioned
}

enum OptimizationStatus {
  applied   // Change was applied to product
  undone    // Change was reverted
}
